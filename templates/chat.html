<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XYA-09 â€” Chat</title>
<style>
/* ------------------------- Base styles (reuse from main demo) ------------------------- */
:root{
  --bg:#f6f7fb; --card:#ffffff; --muted:#6b7280; --text:#111827;
  --accent:#1d4ed8; --glass: rgba(255,255,255,0.6); --radius:12px;
  --shadow: 0 6px 18px rgba(16,24,40,0.06); --max-width:1100px;
}
[data-theme="dark"]{
  --bg:#0b1020; --card:#0f1724; --muted:#9aa4b2; --text:#e6eef6;
  --accent:#60a5fa; --glass: rgba(255,255,255,0.03);
  --shadow: 0 8px 30px rgba(2,6,23,0.8);
}
body{margin:0; font-family:Inter, sans-serif; background:var(--bg); color:var(--text); display:flex; justify-content:center; padding:20px; height:100vh;}
.app{width:100%; max-width:var(--max-width); display:flex; gap:20px; height:100%;}
.left{width:200px; display:flex; flex-direction:column; gap:12px;}
.left h2{font-size:20px; font-weight:700; margin:0;}
.chat-list{flex:1; background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); overflow:auto;}
.chat-item{display:flex; gap:10px; align-items:center; cursor:pointer; padding:8px; border-bottom:1px solid rgba(0,0,0,0.05);}
.chat-item:hover{background:var(--glass);}
.chat-item .avatar-sm{width:36px; height:36px; border-radius:10px; background:linear-gradient(135deg,var(--accent),#7c3aed); color:white; display:grid; place-items:center; font-weight:700;}
.chat-item .info{flex:1;}
.chat-item .info .title{font-weight:700;}
.chat-item .info .last-msg{font-size:12px; color:var(--muted);}
.chat-window{flex:1; display:flex; flex-direction:column; gap:8px;}
.chat-window-header{display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:12px; border-radius:var(--radius); box-shadow:var(--shadow);}
.chat-window-header .title{font-weight:700;}
.chat-window-messages{flex:1; overflow:auto; display:flex; flex-direction:column; gap:8px; padding:12px; background:var(--bg); border-radius:var(--radius);}
.msg{max-width:70%; padding:10px; border-radius:12px; background:var(--glass);}
.msg.me{align-self:flex-end; background:linear-gradient(90deg,var(--accent),#7c3aed); color:white;}
.message-block{display:flex; flex-direction:column; gap:4px;}
.message-block .username{font-size:12px; color:var(--muted); font-weight:600;}
.msg .text{white-space:pre-wrap}
.sendbox{display:flex; gap:8px; padding:8px;}
.sendbox input{flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); outline:0;}
.sendbox button{background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer;}
</style>
</head>
<body>
<div id="app" class="app" data-theme="light">
  <!-- LEFT: Chat list -->
  <div class="left">
    <h2>Chats</h2>
    <div style="display:flex; gap:8px; padding:8px;">
      <button id="loadContacts">Load followers/following</button>
      <input id="contactSearch" placeholder="Search contacts" style="flex:1;padding:6px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)" />
    </div>
    <div class="chat-list" id="chatList"></div>
  </div>

  <!-- RIGHT: Chat window -->
  <div class="chat-window">
    <div class="chat-window-header">
        <div style="display:flex; align-items:center; gap:12px;">
          <a href="/home" class="btn" style="text-decoration:none; padding:6px 10px; background:#eee; border-radius:6px; color:inherit;">â—€ Back</a>
          <div class="title" id="chatWindowTitle">Select a chat</div>
        </div>
      <button id="themeToggle">ðŸŒ™</button>
    </div>
    <div class="chat-window-messages" id="chatWindowMessages"></div>
    <div class="sendbox">
      <input id="chatWindowInput" placeholder="Type a message..." />
      <button id="chatWindowSend">Send</button>
    </div>
  </div>
</div>

<script>
/* ======= Shared state with main demo (localStorage) ======= */
const STORAGE_KEY = "xya09_demo_v1";
let state = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");
state.users = state.users || [];
state.chats = state.chats || [];
state.contacts = state.contacts || [];

/* Utilities */
function findUser(u){
  if(!u) return state.me || {name:'Unknown'};
  // try contacts (email key)
  const byContact = (state.contacts||[]).find(x => x.email === u || x.id === u || x.username === u);
  if(byContact) return byContact;
  // try users array
  const byUser = (state.users||[]).find(x => x.id === u || x.email === u || x.username === u);
  if(byUser) return byUser;
  // fallback to the current signed-in user
  if(state.me && (state.me.id === u || state.me.email === u)) return state.me;
  return {name: u, email: u};
}

// initialize current user from server session so we can identify "me"
async function initCurrentUser(){
  try{
    const r = await fetch('/debug-session');
    if(!r.ok) return;
    const data = await r.json();
    if(data && data.db_row_for_email){
      // db_row_for_email is [id, name, email, username]
      const row = data.db_row_for_email;
      const email = row[2];
      const name = row[1] || row[3] || email;
      state.me = state.me || {};
      state.me.id = email; // use email as unique id
      state.me.email = email;
      state.me.name = name;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
  }catch(e){
    // ignore; user may not be signed in
    console.debug('initCurrentUser failed', e);
  }
}

/* Render chat list */
const chatListEl = document.getElementById('chatList');
const chatWindowTitle = document.getElementById('chatWindowTitle');
const chatWindowMessages = document.getElementById('chatWindowMessages');
const chatWindowInput = document.getElementById('chatWindowInput');
const chatWindowSend = document.getElementById('chatWindowSend');

let activeChatId = null;

function renderChatList(){
  chatListEl.innerHTML = '';
  // If contacts are available, render them first
  if(state.contacts && state.contacts.length){
    state.contacts.forEach(c=>{
      const div = document.createElement('div');
      div.className='chat-item';
      div.innerHTML = `<div class="avatar-sm">${(c.name||c.username||c.email)[0].toUpperCase()}</div>
                       <div class="info">
                         <div class="title">${c.name || c.username || c.email}</div>
                         <div class="last-msg"></div>
                       </div>`;
      div.onclick = ()=> startChatWithContact(c);
      chatListEl.appendChild(div);
    });
    // separator
    const hr = document.createElement('hr'); hr.style.margin='6px 0'; chatListEl.appendChild(hr);
  }
  state.chats.forEach(c=>{
    const div = document.createElement('div');
    div.className='chat-item';
    div.innerHTML = `<div class="avatar-sm">${c.title[0].toUpperCase()}</div>
                     <div class="info">
                       <div class="title">${c.title}</div>
                       <div class="last-msg">${c.messages[c.messages.length-1]?.text || ''}</div>
                     </div>
                     <div class="small">${c.unread?c.unread:''}</div>`;
    div.onclick = ()=> openChat(c.id);
    chatListEl.appendChild(div);
  });
}

function startChatWithContact(contact){
  // If chat already exists with this contact, open it; else create a new chat
  let chat = state.chats.find(x=> x.partners && x.partners.includes(contact.email));
  if(!chat){
    chat = { id: 'chat_' + Date.now(), title: contact.name || contact.username || contact.email, partners: [contact.email], messages: [], unread:0 };
    state.chats.unshift(chat);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  openChat(chat.id);
}

/* Open chat window */
function openChat(chatId){
  activeChatId = chatId;
  const chat = state.chats.find(c=>c.id===chatId);
  if(!chat) return;
  chat.unread = 0;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  renderChatList();
  chatWindowTitle.textContent = chat.title;
  renderMessages(chat);
}

/* Render chat messages */
function renderMessages(chat){
  chatWindowMessages.innerHTML = '';
  chat.messages.forEach(m=>{
    const block = document.createElement('div');
    block.className = 'message-block';
    const nameEl = document.createElement('div');
    nameEl.className = 'username';
    const user = findUser(m.from) || {name: m.from};
    nameEl.textContent = user.name || user.username || user.email || 'Unknown';

    const div = document.createElement('div');
    div.className = 'msg ' + (m.from===state.me.id?'me':'');
    const textSpan = document.createElement('div');
    textSpan.className = 'text';
    textSpan.textContent = m.text;
    div.appendChild(textSpan);

    // align block: sent messages align to right
    if(m.from===state.me.id){
      block.style.alignItems = 'flex-end';
    } else {
      block.style.alignItems = 'flex-start';
    }

    block.appendChild(nameEl);
    block.appendChild(div);
    chatWindowMessages.appendChild(block);
  });
  chatWindowMessages.scrollTop = chatWindowMessages.scrollHeight;
}

/* Send message */
function sendMessage(){
  if(!activeChatId) return;
  const txt = chatWindowInput.value.trim();
  if(!txt) return;
  const chat = state.chats.find(c=>c.id===activeChatId);
  const fromId = (state.me && state.me.id) ? state.me.id : (state.me && state.me.email) || 'me';
  chat.messages.push({from:fromId, text:txt, ts:Date.now()});
  chatWindowInput.value='';
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  renderMessages(chat);
  renderChatList();
}

chatWindowSend.onclick = sendMessage;
chatWindowInput.addEventListener('keypress', e=>{ if(e.key==='Enter') sendMessage(); });

/* Theme toggle */
document.getElementById('themeToggle').onclick = ()=>{
  const cur = document.getElementById('app').getAttribute('data-theme')||'light';
  document.getElementById('app').setAttribute('data-theme', cur==='light'?'dark':'light');
};

/* Initial render */
initCurrentUser().then(()=>{
  renderChatList();
});

/* Load contacts from server (followers + following) */
document.getElementById('loadContacts').onclick = async ()=>{
  try{
    const res = await fetch('/api/chat_contacts');
    if(!res.ok) throw new Error('Failed to load contacts');
    const data = await res.json();
    state.contacts = data.contacts || [];
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    renderChatList();
  }catch(e){
    alert('Could not load contacts: '+e.message);
  }
}

/* Simple contact search */
document.getElementById('contactSearch').addEventListener('input', function(){
  const q = this.value.trim().toLowerCase();
  if(!q){ renderChatList(); return; }
  // filter contacts
  const filtered = (state.contacts||[]).filter(c=> (c.name||c.username||c.email||'').toLowerCase().includes(q));
  chatListEl.innerHTML='';
  filtered.forEach(c=>{
    const div = document.createElement('div');
    div.className='chat-item';
    div.innerHTML = `<div class="avatar-sm">${(c.name||c.username||c.email)[0].toUpperCase()}</div>
                     <div class="info">
                       <div class="title">${c.name || c.username || c.email}</div>
                       <div class="last-msg"></div>
                     </div>`;
    div.onclick = ()=> startChatWithContact(c);
    chatListEl.appendChild(div);
  });
});
</script>
</body>
</html>
